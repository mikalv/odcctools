builddir = @builddir@
top_builddir = @top_builddir@
srcdir = @srcdir@
top_srcdir = @top_srcdir@

prefix		= @prefix@
exec_prefix	= @exec_prefix@
bindir		= @bindir@

VPATH = @srcdir@

CC              = @CC@
CFLAGS          = @CFLAGS@
MDYNAMICNOPIC   = @MDYNAMICNOPIC@
CPPFLAGS        = @CPPFLAGS@
DEFS            = @DEFS@
LDFLAGS         = @LDFLAGS@

INSTALL		= @INSTALL@
INSTALL_PROGRAM	= @INSTALL_PROGRAM@
transform       = @program_transform_name@

MYINCLUDES      = -I$(builddir) -I$(srcdir) -I$(top_builddir)/include \
			-I$(top_srcdir)/include
MYWARNINGS      = -Wall -Wno-long-double
MYDEFS          = -DINTERIM_PPC64 -DDEBUG
MYLDFLAGS	= -L$(top_builddir)/libstuff
MYLIBS		= -lstuff

MYCOMPILEFLAGS	= $(CFLAGS) $(MDYNAMICNOPIC) $(CPPFLAGS) $(DEFS) \
	$(MYINCLUDES) $(MYWARNINGS) $(MYDEFS)
MYLINKFLAGS	= $(LDFLAGS) $(MYLDFLAGS) $(MYLIBS)

CFILES = ld.c pass1.c objects.c sections.c cstring_literals.c symbols.c \
         fvmlibs.c layout.c specs.c pass2.c generic_reloc.c rld.c sets.c \
         4byte_literals.c 8byte_literals.c literal_pointers.c dylibs.c \
         indirect_sections.c mod_sections.c i860_reloc.c ppc_reloc.c \
         m88k_reloc.c hppa_reloc.c sparc_reloc.c coalesced_sections.c \
         apple_version.c makeUser.c

MIG	=	/usr/bin/mig

OBJS = $(CFILES:.c=.o) 
.c.o:
	$(CC) $(MYCOMPILEFLAGS) -c -o $@ $<

.PHONY: default clean distclean install

default: ld

makeUser.o ld.o: make.h

make.h makeUser.c: make.defs
	$(MIG) $<
	rm -f makeServer.c

ld: $(OBJS)
	$(CC) -o $@ $^ $(MYLINKFLAGS)

install: ld
	mkdir -p $(DESTDIR)/$(bindir)
	$(INSTALL_PROGRAM) ld \
		$(DESTDIR)/$(bindir)/`echo ld | sed '$(transform)'`

clean:
	rm -r -f *.o
	rm -f ld
	rm -f make.h makeUser.c
